- name: Deploy WireGuard generator config
  template:
    src: wg-gen.conf.j2
    dest: /etc/wireguard/wg-gen.conf
    owner: root
    group: root
    mode: '0600'

- name: Deploy WireGuard generator
  copy:
    src: wg-gen.sh
    dest: /etc/wireguard/wg-gen.sh
    owner: root
    group: root
    mode: '0755'

- name: Deploy WireGuard Git credential file
  lineinfile:
    path: /root/.git-credentials
    line: "{{ wg_credential }}"
    create: yes
    owner: root
    group: root
    mode: '0600'
  when: wg_credential is defined

- name: Obtain WireGuard config repo
  git:
    repo: "{{ wg_repo }}"
    dest: /etc/wireguard/repo.d
    force: yes
  when: wg_credential is defined and wg_repo is defined

# TODO idempotency
- name: Generate WireGuard config
  command: /etc/wireguard/wg-gen.sh

- name: Enable WireGuard
  systemd:
    name: wg-quick@wg0
    state: restarted
    enabled: yes

# TODO other options https://www.cyberciti.biz/faq/centos-8-set-up-wireguard-vpn-server/
- include_role:
    name: sysctl
  loop:
  - { file: '99-wireguard', option: 'net.ipv4.ip_forward', value: '1' }
  - { file: '99-wireguard', option: 'net.ipv6.conf.all.forwarding', value: '1' }
